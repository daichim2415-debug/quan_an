<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gi·ªè H√†ng C·ªßa B·∫°n</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <a href="/" class="logo">‚Üê TI·∫æP T·ª§C MUA H√ÄNG</a>
        </div>
    </nav>

    <div class="container">
        <h2>Gi·ªè H√†ng C·ªßa B·∫°n</h2>
        
        <table>
            <thead>
                <tr>
                    <th>H√¨nh</th>
                    <th>T√™n m√≥n</th>
                    <th>ƒê∆°n gi√°</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>Th√†nh ti·ªÅn</th>
                    <th>X√≥a</th>
                </tr>
            </thead>
            <tbody id="cart-body">
                </tbody>
        </table>
        
        <div class="total-row" id="total-price" style="margin: 20px 0;">
            T·ªïng c·ªông: 0 ƒë
        </div>

        <hr>

        <div class="input-form" style="max-width: 500px; margin: auto;">
            <h3 style="text-align:center">Th√¥ng Tin Giao H√†ng</h3>
            <input type="text" id="ten_khach" placeholder="T√™n c·ªßa b·∫°n" required>
            <textarea id="dia_chi" placeholder="ƒê·ªãa ch·ªâ giao h√†ng (S·ªë nh√†, ƒë∆∞·ªùng...)" rows="3"></textarea>
            <button onclick="checkout()">ƒê·∫∂T H√ÄNG NGAY</button>
        </div>
    </div>

    <script>
        let gioHang = JSON.parse(localStorage.getItem('giohang')) || [];

        // 1. Hi·ªÉn th·ªã gi·ªè h√†ng ra b·∫£ng
        function renderCart() {
            const tbody = document.getElementById('cart-body');
            tbody.innerHTML = '';
            let tongTien = 0;

            if (gioHang.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">Gi·ªè h√†ng tr·ªëng tr∆°n!</td></tr>';
                document.getElementById('total-price').innerText = "T·ªïng c·ªông: 0 ƒë";
                return;
            }

            gioHang.forEach((item, index) => {
                let thanhTien = item.gia * item.sl;
                tongTien += thanhTien;
                
                tbody.innerHTML += `
                    <tr>
                        <td><img src="${item.hinh}" width="50" style="border-radius:4px"></td>
                        <td>${item.ten}</td>
                        <td>${parseInt(item.gia).toLocaleString()}</td>
                        <td>
                            <button onclick="changeQty(${index}, -1)" style="width:30px; padding:2px">-</button>
                            ${item.sl}
                            <button onclick="changeQty(${index}, 1)" style="width:30px; padding:2px">+</button>
                        </td>
                        <td>${thanhTien.toLocaleString()} ƒë</td>
                        <td><a href="#" onclick="removeItem(${index})" style="color:red">X√≥a</a></td>
                    </tr>
                `;
            });

            document.getElementById('total-price').innerText = `T·ªïng c·ªông: ${tongTien.toLocaleString()} ƒë`;
        }

        // 2. TƒÉng gi·∫£m s·ªë l∆∞·ª£ng
        function changeQty(index, delta) {
            gioHang[index].sl += delta;
            if (gioHang[index].sl < 1) gioHang[index].sl = 1;
            localStorage.setItem('giohang', JSON.stringify(gioHang));
            renderCart();
        }

        // 3. X√≥a m√≥n
        function removeItem(index) {
            if(confirm('B·∫°n mu·ªën b·ªè m√≥n n√†y?')){
                gioHang.splice(index, 1);
                localStorage.setItem('giohang', JSON.stringify(gioHang));
                renderCart();
            }
        }

        // 4. CH·ªêT ƒê∆†N (G·ª≠i v·ªÅ Server Node.js)
        async function checkout() {
            if (gioHang.length === 0) return alert('Gi·ªè h√†ng tr·ªëng!');
            const ten = document.getElementById('ten_khach').value;
            const diachi = document.getElementById('dia_chi').value;

            if (!ten || !diachi) return alert('Vui l√≤ng nh·∫≠p t√™n v√† ƒë·ªãa ch·ªâ!');

            // T√≠nh t·ªïng ti·ªÅn
            const tongTien = gioHang.reduce((sum, item) => sum + (item.gia * item.sl), 0);
            
            // T·∫°o n·ªôi dung ƒë∆°n h√†ng d·∫°ng ch·ªØ
            const noiDung = gioHang.map(item => `${item.ten} (x${item.sl})`).join(', ') + ` - ƒêC: ${diachi}`;

            // G·ª≠i API
            try {
                const res = await fetch('http://localhost:3000/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ten_khach: ten,
                        tong_tien: tongTien,
                        noi_dung: noiDung
                    })
                });
                const data = await res.json();
                
                alert("üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng! Ch·ªß qu√°n ƒë√£ nh·∫≠n ƒë∆°n.");
                localStorage.removeItem('giohang'); // X√≥a gi·ªè
                window.location.href = '/'; // V·ªÅ trang ch·ªß
            } catch (err) {
                alert("L·ªói khi g·ª≠i ƒë∆°n h√†ng!");
                console.error(err);
            }
        }

        // Ch·∫°y h√†m hi·ªÉn th·ªã khi v√†o trang
        renderCart();
    </script>
</body>
</html>