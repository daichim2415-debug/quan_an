<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; background: #f1f2f6; }
        
        .sidebar { height: 100vh; background: #2d3436; color: white; width: 260px; position: fixed; padding-top: 20px; }
        .sidebar h3 { color: #ff4757; font-weight: 800; text-align: center; margin-bottom: 30px; letter-spacing: 2px; }
        .sidebar a { color: #b2bec3; display: block; padding: 15px 30px; text-decoration: none; font-weight: 500; transition: 0.3s; }
        .sidebar a:hover, .sidebar a.active { background: #ff4757; color: white; }
        
        .content { margin-left: 260px; padding: 30px; }
        .card-admin { background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); padding: 20px; border:none; }
        
        .table thead th { background: #f8f9fa; border:none; color: #636e72; font-weight: 600; text-transform: uppercase; font-size: 0.85rem; }
        .table td { vertical-align: middle; padding: 15px; }
        .btn-add { background: #2ed573; color: white; border-radius: 50px; padding: 8px 20px; border:none; font-weight: 600; }
        
        .status-badge { padding: 5px 12px; border-radius: 30px; font-size: 0.8rem; font-weight: 600; }
        .st-cho_duyet { background: #ffeaa7; color: #d35400; }
        .st-dang_lam { background: #74b9ff; color: #0984e3; }
        .st-dang_giao { background: #a29bfe; color: #6c5ce7; }
        .st-hoan_thanh { background: #55efc4; color: #00b894; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3><i class="fas fa-user-shield"></i> ADMIN</h3>
        <a href="#" onclick="showTab('orders')" class="active"><i class="fas fa-receipt me-2"></i> Đơn Hàng</a>
        <a href="#" onclick="showTab('products')"><i class="fas fa-hamburger me-2"></i> Món Ăn</a>
        <a href="/" target="_blank"><i class="fas fa-globe me-2"></i> Xem Web</a>
        <a href="#" onclick="logout()" class="text-danger mt-5"><i class="fas fa-sign-out-alt me-2"></i> Đăng Xuất</a>
    </div>

    <div class="content">
        <div id="tab-orders">
            <h3 class="fw-bold mb-4">Quản Lý Đơn Hàng</h3>
            <div class="card-admin">
                <table class="table">
                    <thead><tr><th>ID</th><th>Khách</th><th>Chi tiết</th><th>Tổng</th><th>Trạng thái</th></tr></thead>
                    <tbody id="admin-orders"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-products" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold m-0">Danh Sách Món</h3>
                <button class="btn-add" data-bs-toggle="modal" data-bs-target="#addModal">+ Thêm Món</button>
            </div>
            <div class="row g-3" id="admin-products"></div>
        </div>
    </div>

    <div class="modal fade" id="addModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Thêm Món Mới</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="form-add">
                        <input type="text" id="p-name" class="form-control" placeholder="Tên món" required>
                        <input type="number" id="p-price" class="form-control" placeholder="Giá tiền" required>
                        <input type="file" id="p-img" class="form-control" required>
                        <button class="btn-add w-100 mt-2">LƯU MÓN</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user'));
        if(!user || user.role !== 'admin') window.location.href = '/login.html';

        document.addEventListener('DOMContentLoaded', () => { loadOrders(); loadProducts(); });

        function showTab(t) {
            document.getElementById('tab-orders').style.display = t==='orders'?'block':'none';
            document.getElementById('tab-products').style.display = t==='products'?'block':'none';
        }

        async function loadOrders() {
            const res = await fetch('/api/all-orders');
            const data = await res.json();
            const tb = document.getElementById('admin-orders');
            tb.innerHTML = '';
            data.forEach(o => {
                const items = JSON.parse(o.items_json).map(i => `${i.ten} x${i.sl}`).join(', ');
                tb.innerHTML += `
                    <tr>
                        <td>#${o.id}</td>
                        <td><strong>${o.customer_name}</strong><br><small class="text-muted">${o.phone}</small></td>
                        <td>${items}</td>
                        <td class="text-danger fw-bold">${Number(o.total_money).toLocaleString()}</td>
                        <td>
                            <select onchange="upStat(${o.id}, this.value)" class="form-select form-select-sm status-badge st-${o.status}" style="width:130px;">
                                <option value="cho_duyet" ${o.status==='cho_duyet'?'selected':''}>Chờ duyệt</option>
                                <option value="dang_lam" ${o.status==='dang_lam'?'selected':''}>Đang làm</option>
                                <option value="dang_giao" ${o.status==='dang_giao'?'selected':''}>Đang giao</option>
                                <option value="hoan_thanh" ${o.status==='hoan_thanh'?'selected':''}>Hoàn thành</option>
                            </select>
                        </td>
                    </tr>
                `;
            });
        }

        async function upStat(id, st) { await fetch('/api/order-status', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, status:st})}); loadOrders(); }
        
        async function loadProducts() {
            const res = await fetch('/api/products');
            const data = await res.json();
            const div = document.getElementById('admin-products');
            div.innerHTML = '';
            data.forEach(p => {
                div.innerHTML += `
                    <div class="col-md-3">
                        <div class="card-admin p-3 text-center">
                            <img src="${p.hinh_anh}" style="width:100%; height:150px; object-fit:cover; border-radius:10px;">
                            <h6 class="fw-bold mt-2">${p.ten_mon}</h6>
                            <p class="text-danger fw-bold">${Number(p.gia).toLocaleString()}</p>
                            <button onclick="delProd(${p.id})" class="btn btn-sm btn-outline-danger w-100">Xóa</button>
                        </div>
                    </div>
                `;
            });
        }

        document.getElementById('form-add').onsubmit = async (e) => {
            e.preventDefault();
            const fd = new FormData();
            fd.append('ten_mon', document.getElementById('p-name').value);
            fd.append('gia', document.getElementById('p-price').value);
            fd.append('hinh_anh', document.getElementById('p-img').files[0]);
            await fetch('/api/products', {method:'POST', body:fd});
            location.reload();
        }

        async function delProd(id) { if(confirm('Xóa?')) { await fetch('/api/products/'+id, {method:'DELETE'}); loadProducts(); } }
        function logout() { localStorage.removeItem('user'); window.location.href = '/login.html'; }
    </script>
</body>
</html>