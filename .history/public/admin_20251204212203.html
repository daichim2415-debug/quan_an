<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard PRO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark px-4">
        <a class="navbar-brand" href="#">QU·∫¢N TR·ªä VI√äN</a>
        <a href="/" target="_blank" class="btn btn-outline-light btn-sm">Xem Web Kh√°ch</a>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-2">
                <div class="list-group">
                    <button class="list-group-item list-group-item-action active" onclick="showSection('orders')">üì¶ ƒê∆°n H√†ng</button>
                    <button class="list-group-item list-group-item-action" onclick="showSection('products')">üçî M√≥n ƒÇn</button>
                    <button class="list-group-item list-group-item-action" onclick="showSection('categories')">üìÇ Danh M·ª•c</button>
                </div>
            </div>

            <div class="col-md-10">
                <div id="sec-orders">
                    <h3>Qu·∫£n L√Ω ƒê∆°n H√†ng (Realtime)</h3>
                    <button onclick="loadOrders()" class="btn btn-sm btn-primary mb-3">L√†m m·ªõi</button>
                    <div class="table-responsive bg-white rounded shadow-sm p-3">
                        <table class="table align-middle">
                            <thead class="table-secondary">
                                <tr><th>ID</th><th>Kh√°ch</th><th>Chi ti·∫øt</th><th>T·ªïng</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th></tr>
                            </thead>
                            <tbody id="order-table"></tbody>
                        </table>
                    </div>
                </div>

                <div id="sec-products" style="display:none;">
                    <div class="d-flex justify-content-between mb-3">
                        <h3>Danh S√°ch M√≥n</h3>
                        <button class="btn btn-success" onclick="document.getElementById('addProdForm').classList.toggle('d-none')">+ Th√™m M√≥n</button>
                    </div>

                    <form id="addProdForm" class="card p-3 mb-4 d-none shadow">
                        <div class="row g-2">
                            <div class="col-md-3"><input type="text" id="p-name" class="form-control" placeholder="T√™n m√≥n"></div>
                            <div class="col-md-2"><input type="number" id="p-price" class="form-control" placeholder="Gi√°"></div>
                            <div class="col-md-3">
                                <select id="p-cat" class="form-select"></select>
                            </div>
                            <div class="col-md-2"><input type="file" id="p-img" class="form-control"></div>
                            <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">L∆∞u</button></div>
                        </div>
                    </form>

                    <table class="table bg-white shadow-sm">
                        <thead><tr><th>H√¨nh</th><th>T√™n</th><th>Danh m·ª•c</th><th>Gi√°</th><th>X√≥a</th></tr></thead>
                        <tbody id="prod-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => { loadOrders(); loadCats(); loadProds(); });
        
        function showSection(id) {
            document.getElementById('sec-orders').style.display = 'none';
            document.getElementById('sec-products').style.display = 'none';
            document.getElementById('sec-' + id).style.display = 'block';
        }

        // --- ORDER LOGIC ---
        async function loadOrders() {
            const res = await fetch('/api/all-orders');
            const data = await res.json();
            const tbody = document.getElementById('order-table');
            tbody.innerHTML = '';
            
            const statusOpts = {
                'cho_duyet': 'Ch·ªù duy·ªát', 'dang_lam': 'ƒêang l√†m', 
                'dang_giao': 'ƒêang giao', 'hoan_thanh': 'Ho√†n th√†nh', 'da_huy': 'ƒê√£ h·ªßy'
            };

            data.forEach(o => {
                const items = JSON.parse(o.items_json).map(i => `${i.name} (x${i.sl})`).join('<br>');
                let optsHTML = '';
                for(let k in statusOpts) {
                    optsHTML += `<option value="${k}" ${o.status===k?'selected':''}>${statusOpts[k]}</option>`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>#${o.id}</td>
                        <td>
                            <strong>${o.customer_name}</strong><br>
                            <small>${o.phone}</small><br>
                            <small class="text-muted">${o.address}</small>
                        </td>
                        <td>${items}</td>
                        <td class="text-danger fw-bold">${Number(o.total_money).toLocaleString()}</td>
                        <td>
                            <select onchange="updateStatus(${o.id}, this.value)" class="form-select form-select-sm ${getStatColor(o.status)}">
                                ${optsHTML}
                            </select>
                        </td>
                        <td><small>${new Date(o.created_at).toLocaleTimeString()}</small></td>
                    </tr>
                `;
            });
        }

        function getStatColor(s) {
            if(s === 'cho_duyet') return 'bg-warning text-dark';
            if(s === 'hoan_thanh') return 'bg-success text-white';
            if(s === 'da_huy') return 'bg-secondary text-white';
            return 'bg-info text-white';
        }

        async function updateStatus(id, st) {
            await fetch('/api/order-status', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({id, status: st})
            });
            Swal.fire({toast:true, position:'top-end', icon:'success', title:'C·∫≠p nh·∫≠t th√†nh c√¥ng', timer:1500});
        }

        // --- PRODUCT LOGIC ---
        async function loadCats() {
            const res = await fetch('/api/categories');
            const data = await res.json();
            const sel = document.getElementById('p-cat');
            data.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
        }

        async function loadProds() {
            const res = await fetch('/api/products');
            const data = await res.json();
            document.getElementById('prod-table').innerHTML = data.map(p => `
                <tr>
                    <td><img src="${p.image}" width="40"></td>
                    <td>${p.name}</td>
                    <td>${p.category_id}</td>
                    <td>${Number(p.price).toLocaleString()}</td>
                    <td><button onclick="delProd(${p.id})" class="btn btn-sm btn-outline-danger">X</button></td>
                </tr>
            `).join('');
        }

        // X·ª≠ l√Ω th√™m m√≥n form submit (T·ª± vi·∫øt n·ªët ph·∫ßn g·ªçi API POST nh∆∞ b√™n client)
        document.getElementById('addProdForm').onsubmit = async (e) => {
            e.preventDefault();
            const fd = new FormData();
            fd.append('name', document.getElementById('p-name').value);
            fd.append('price', document.getElementById('p-price').value);
            fd.append('category_id', document.getElementById('p-cat').value);
            fd.append('image', document.getElementById('p-img').files[0]);
            
            await fetch('/api/products', {method:'POST', body: fd});
            alert('Th√™m th√†nh c√¥ng'); loadProds();
        }
        
        async function delProd(id) {
            if(confirm('X√≥a nh√©?')) { await fetch('/api/products/'+id, {method:'DELETE'}); loadProds(); }
        }
    </script>
</body>
</html>